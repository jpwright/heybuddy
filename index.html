<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="jquery-1.11.2.min.js"></script>
    <script src="https://code.createjs.com/easeljs-0.8.0.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.0.min.js"></script>
    <script type="text/javascript">

    var canvas;
    var stage;
    
    var FPS = 24; // Game FPS
    
    var NUM_BUDDIES = 100; // How many buddies are on the screen at any given time
    var BUDDY_SPEED = 0.01; // How fast the buddies walk towards you
    var BUDDY_AVOID_RATE = 2000; // The rate at which a buddy moves to avoid the player, as a coefficient to buddy speed
    var BUDDY_AVOID_START = 0.8; // The distance at which a buddy starts to avoid (move left or right)
    var BUDDY_AVOID_END = 0.4; // The distance at which a buddy disappears.
    var BUDDY_PADDING = 1/6; // How far away from the edges of the screen the buddies should start
    var BUDDY_SPACING = 2; // How far away the buddies should be from eachother
    var BUDDY_CLOSEST = 3; // How close the very first buddy should start at
    
    var BUDDY_MIN_CHANGE_TIME = 20; // Frames until buddy can change type
    var BUDDY_MAX_CHANGE_TIME = 100; // Frames until buddy HAS to change type. Actual change time is somewhere in between
    var BUDDY_MIN_CHANGE_Z = 0.7; // Closer than this, the buddy can't change type
    
    var BUDDY_ACCELERATION = 0.00001; // Amount the speed of the buddies increases over time
    
    var HAND_ALPHA = 0.9; // Alpha of the player's hand
    
    var NAMETAG_OFFSET = 450; // How high above the center of the buddy the nametag should go
    var NAMETAG_SIZE = 36; // Font size of name tag in px
    
    var HORIZON_PCT = 4/5; // Percentage down the screen the horizon is. Lower num = more crotch
    
    var HITBOX_WIDTH = 150; // Width of bounding box for determining successful encounter
    
    var KEYCODE_LEFT = 37, 
      KEYCODE_RIGHT = 39,
      KEYCODE_UP = 38, 
      KEYCODE_DOWN = 40,
      KEYCODE_A = 65,
      KEYCODE_S = 83,
      KEYCODE_D = 68,
      KEYCODE_F = 70;
    
    var NAMES = ["Abby", "Agatha", "Allie", "Andrea", "Becky", "Binyamin", "Buddy", "Chief", "Chill", "Cliff", "Curly", "Delilah", "Diana", "Dinnerbone", "Dr. Feelgood", "Dr. Zizmor", "Edward", "Emily", "Francis", "Grandma", "Grandpa", "Guillermo", "Jake", "James", "Jason", "Jenkins", "Jimothy", "John F.", "John L.", "Jorge", "Junior", "Kenny", "Lobe", "Mesopotamia", "Mr. Smith", "Nina", "Peabody", "Quincent", "Rebecca", "Rex", "Richard", "Saadi", "Sally", "Steven", "Timothy", "Unknown", "Victoria", "Xavier", "Yasmine", "Zachary", "Zadik"];
    
    var STATE_NAMES = {"open": "nothing", "hand": "high five", "fist": "fist bump", "shake": "handshake"};
    
    var hands = [];
    var hand;
    var fist;
    var buddy;
    var types = ["open", "hand", "fist", "shake"];
    
    var message;
    
    var shamebar;
    
    var shamelevel = 0;
    
    var mouseX;
    var mouseY;
   
    var buddies = []; // Array holding all the buddy objects.
   
    var handPos;
    
    function init() {
      canvas = document.getElementById('game');
      width = canvas.width;
      height = canvas.height;
      stage = new createjs.Stage(canvas);
      
      
      for (var i = 0; i < NUM_BUDDIES; i++) {
	createBuddy(i, (i*BUDDY_SPACING)+BUDDY_CLOSEST);
      }
      
      for (var j = 0; j < types.length; j++) {
	hands[j] = createHand(types[j]);
      }
      changeHand("open");
      
      message = new createjs.Text("Hey Buddy!", "20px Arial", "#ff2222");
      message.x = 0;
      message.y = 0;
      stage.addChild(message);
      
      updateStage();
      
      stage.on("stagemousemove", function(evt) {
	for (var i = 0; i < hands.length; i++) {
	  hands[i].obj.x = evt.stageX - hands[i].obj.getBounds().width/2;
	  hands[i].obj.y = evt.stageY - hands[i].obj.getBounds().height/2;
	  mouseX = evt.stageX;
	  mouseY = evt.stageY;
	}
      });
      
      this.document.onkeydown = keyPressed;
      this.document.onkeyup = function() {
	changeHand("open");
      };
      
      createjs.Ticker.addEventListener("tick", tick);
      createjs.Ticker.setFPS(FPS);
      function tick(evt) {
      
	BUDDY_SPEED += BUDDY_ACCELERATION;
      
	for (var i = 0; i < buddies.length; i++) {
	  var b = buddies[i];
	  
	  // Buddy movement
	  b.z -= BUDDY_SPEED;
	  if (b.z < BUDDY_AVOID_START && (b.z > BUDDY_AVOID_END)) {
	    if (b.x > canvas.width/2) {
	      b.x += BUDDY_AVOID_RATE * BUDDY_SPEED;
	    } else {
	      b.x -= BUDDY_AVOID_RATE * BUDDY_SPEED;
	    }
	    moveAllBuddies(b, b.x, b.z);
	    
	    if (b.encountered == false) {
	      if ((b.state == handPos) && (mouseX >= (b.x - HITBOX_WIDTH)) && (mouseX <= (b.x + HITBOX_WIDTH))) {
		message.text = "Sweet "+STATE_NAMES[b.state]+" with "+b.name;
	      } else {
		message.text = "Awkward moment with "+b.name;
	      }
	      b.encountered = true;
	    }
	    
	  } else if (b.z <= BUDDY_AVOID_END) {
	    hideAllBuddies(b);
	    console.log("new buddy!");
	    createBuddy(i, ((NUM_BUDDIES-1)*BUDDY_SPACING)+BUDDY_CLOSEST);
	    moveAllBuddies(buddies[i], b.x, b.z);
	    
	    
	    
	    
	  } else {
	    moveAllBuddies(b, b.x, b.z);
	  }
	  
	  // Buddy type changing
	  b.waitCounter += 1;
	  if ((b.waitCounter > b.waitLimit) && (b.z > BUDDY_MIN_CHANGE_Z)) {
	    // Reset the counter
	    b.waitCounter = 0;
	    // Come up with a new wait time
	    var newWait = newBuddyWaitTime();
	    b.waitLimit = newWait;
	    // Change the buddy to a new random state
	    
	    var goodChoice = false;
	    var newType;
	    while (!goodChoice) {
	      var choice = Math.round(Math.random() * types.length);
	      var newType = types[choice];
	      if ((newType != b.type) && (newType != "open")) {
		goodChoice = true;
	      }
	    }
	    changeBuddyType(i, newType);
	  }
	  
	}
      
	updateStage();
	var fps = document.getElementById('fps');
	fps.innerHTML = createjs.Ticker.getMeasuredFPS();
      
      }


    }
    
    function updateStage() {
      stage.update();
    }
    
    function createHand(type) {
      h = drawHand(type);
      h.x = canvas.width / 2;
      h.y = canvas.height / 2;
      stage.addChild(h);
      d = {"type": type, "obj": h};
      return d;
    }

    function drawHand(type) {
      var h;
      switch(type) {
	case "open":
	  h = new createjs.Bitmap("open.png");
	  break;
	case "hand":
	  h = new createjs.Bitmap("hand.png");
	  break;
	case "fist":
	  h = new createjs.Bitmap("fist.png");
	  break;
	case "shake":
	  h = new createjs.Bitmap("shake.png");
	  break;
      }      
      h.set({alpha: HAND_ALPHA});
      return h;
    }
    
    function randomBuddyStart() {
      return canvas.width*BUDDY_PADDING + (Math.random() * canvas.width*(1-(2*BUDDY_PADDING)));
    }
    
    function randomState() {
      var choice = Math.round(Math.random() * types.length-1);
      return types[choice];
    }
    
    function createBuddy(i, start) {
      var d = {};
      
      var container = new createjs.Container();
      
      for (var j = 0; j < types.length; j++) {
	var b = drawBuddy(types[j]);
	container.addChildAt(b, j);
      }
      
      var name = NAMES[Math.round(Math.random() * (NAMES.length - 1))];
      
      var n = new createjs.Text(name, NAMETAG_SIZE.toString()+"px Arial", "#ff2222");
      n.x = -100;
      n.y = -100;
      container.addChildAt(n, types.length);
      
      stage.addChildAt(container, 0);
      
      var state = randomState();
      
      buddies[i] = {"container": container, "z": start, "x": randomBuddyStart(), "state": state, "waitCounter": 0, "waitLimit": newBuddyWaitTime(), "name" : name, "encountered": false};
      changeBuddyType(i, state);
    }
    
    function drawBuddy(type) {
      var b;
      switch(type) {
	case "open":
	  b = new createjs.Bitmap("buddy-open.png");
	  break;
	case "hand":
	  b = new createjs.Bitmap("buddy-hand.png");
	  break;
	case "fist":
	  b = new createjs.Bitmap("buddy-fist.png");
	  break;
	case "shake":
	  b = new createjs.Bitmap("buddy-shake.png");
	  break;
      }
      b.x = canvas.width / 2;
      b.y = canvas.height / 2;
      b.scaleX = 0.01;
      b.scaleY = 0.01;
      return b;
    }
    
    function newBuddyWaitTime() {
      return (Math.random() * (BUDDY_MAX_CHANGE_TIME - BUDDY_MIN_CHANGE_TIME)) + BUDDY_MIN_CHANGE_TIME;
    }
    
    /*function moveAllBuddies(d, x, z) {
      var c = d.container;
      var bounds = c.getBounds();
      c.scaleX = 1/z;
      c.scaleY = 1/z;
      var effWidth = bounds.width * c.scaleX;
      var effHeight = bounds.height * c.scaleY;
      c.x = x - effWidth/2;
      c.y = 3*canvas.height/4 - effHeight/2 - 200/z;
      c.set({alpha: 5/z});
    }*/
    
    function moveAllBuddies(d, x, z) {
      for (var j = 0; j < types.length; j++) {
	var b = d.container.getChildAt(j);
	moveBuddy(b, x, z);
      }
      moveName(d, x, z);
    }
    
    function moveName(d, x, z) {
      //console.log(d.name);
      
      var n = d.container.getChildAt(types.length);
      var bounds = n.getBounds();
      n.scaleX = 1/z;
      n.scaleY = 1/z;
      var effWidth = bounds.width * n.scaleX;
      var effHeight = bounds.height * n.scaleY;
      n.x = x - effWidth/2 + 10;
      n.y = HORIZON_PCT*canvas.height - effHeight/2 - NAMETAG_OFFSET/z;
      n.set({alpha: 5/z});
    }
    
    function moveBuddy(b, x, z) {
      // b is the buddy object
      // x is horizontal position on the screen
      // z is distance away from viewer
      var bounds = b.getBounds();
      b.scaleX = 1/z;
      b.scaleY = 1/z;
      var effWidth = bounds.width * b.scaleX;
      var effHeight = bounds.height * b.scaleY;
      b.x = x - effWidth/2;
      b.y = HORIZON_PCT*canvas.height - effHeight/2;
      b.set({alpha: 5/z});
    
    }
    
    function changeBuddyType(i, type) {
      var d = buddies[i];
      d.state = type;
      for (var j = 0; j < types.length; j++) {
	var b = d.container.getChildAt(j);
	if (types[j] != type) {
	  hideBuddy(b);
	} else {
	  showBuddy(b);
	}
      }
    }
    
    function hideAllBuddies(d) {
      for (var j = 0; j < types.length+1; j++) {
	var b = d.container.getChildAt(j);
	hideBuddy(b);
      }
    }
    
    function hideBuddy(b) {
      b.visible = false;
    }
    
    function showBuddy(b) {
      b.visible = true;
    }
    
    function changeHand(type) {
      for (var i = 0; i < hands.length; i++) {
	hands[i].obj.visible = false;
	if (hands[i].type == type) {
	  hands[i].obj.visible = true;
	}
      }
      handPos = type;
    }

    function keyPressed(evt) {
      //console.log(event.keyCode);
      switch(event.keyCode) {
	case KEYCODE_A:
	  changeHand("hand");
	  break;
	case KEYCODE_S: 
	  changeHand("fist");
	  break;
	case KEYCODE_D:
	  changeHand("shake");
	  break;
	case KEYCODE_F:
	  break;
      }
      updateStage();
    }

    </script>
  </head>
  <body onload="init();">
    <canvas id="game" width="800" height="600"></canvas>
    <br />
    <span id="fps-container"><span id="fps">Loading</span> FPS</span>
  </body>
</html>
      